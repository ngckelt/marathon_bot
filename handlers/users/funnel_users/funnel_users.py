import time
from pprint import pprint

from aiogram import types
from aiogram.dispatcher import FSMContext
from aiogram.dispatcher.filters.builtin import CommandStart

from loader import dp

from keyboards.default.funnel_users import funnel_users_markups
from keyboards.default.funnel_users.funnel_users_markups import create_markup
from keyboards.inline.funnel_users import funnel_users_markups as inline_funnel_users_markups
from keyboards.inline.paginator import Paginator, pagination_callback

from utils.db_api.db import FunnelUsersModel, ReviewsModel, MarathonMembersModel

from states.funnel_users.funnel_users import FunnelUsers


async def update_funnel_user(message):
    await FunnelUsersModel.update_funnel_user(
        telegram_id=message.from_user.id,
        last_message=message.text,
        last_update_time=time.time()
    )


async def has_idea(message: types.Message, state: FSMContext):
    await message.answer(
        "–ù–∞–≤–µ—Ä–Ω—è–∫–∞ —Ç—ã —Å–ª—ã—à–∞–ª(–∞) –ø—Ä–æ –ª—é–¥–µ–π, –∫–æ—Ç–æ—Ä—ã–µ –ø—Ä–æ—Å—ã–ø–∞—é—Ç—Å—è –≤ 5 —É—Ç—Ä–∞, –∏ —ç—Ç–æ –ø–æ–º–æ–≥–∞–µ—Ç –∏–º –¥–æ—Å—Ç–∏–≥–∞—Ç—å –±–æ–ª–µ–µ –≤—ã—Å–æ–∫–∏—Ö "
        "—Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –≤–æ –≤—Å–µ—Ö —Å—Ñ–µ—Ä–∞—Ö –∂–∏–∑–Ω–∏.\n"
        "‚ú® –ü—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–µ–µ —Ä–∞–±–æ—Ç–∞—Ç—å –∏ –±–æ–ª—å—à–µ —É—Å–ø–µ–≤–∞—Ç—å\n"
        "‚ú® –ß—É–≤—Å—Ç–≤–æ–≤–∞—Ç—å —Å–µ–±—è –ª—É—á—à–µ –∏ –∑–¥–æ—Ä–æ–≤–µ–µ\n"
        "‚ú® –°—Ç–∞—Ç—å —á–µ–ª–æ–≤–µ–∫–æ–º —Å –ø—Ä–æ–∫–∞—á–µ–Ω–Ω–æ–π —Å–∏–ª–æ–π –≤–æ–ª–∏\n"
        "‚ú® –°—Ç–∞—Ç—å –ø—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–∏ –±–æ–ª–µ–µ —É—Å—Ç–æ–π—á–∏–≤—ã–º"
    )

    await message.answer(
        "–ü—Ä–∏–∑–Ω–∞–≤–∞–π—Å—è, –µ—Å—Ç—å –ª–∏ —É —Ç–µ–±—è –∏–¥–µ—è –≤–Ω–µ–¥—Ä–∏—Ç—å –ø—Ä–∏–≤—ã—á–∫—É –µ–∂–µ–¥–Ω–µ–≤–Ω–æ –ø—Ä–æ—Å—ã–ø–∞—Ç—å—Å—è –≤ 5-6 —É—Ç—Ä–∞? üòâ",
        reply_markup=create_markup(2, '–î–ê', '–ù–ï–¢')
    )
    await FunnelUsers.is_interested.set()


@dp.message_handler(CommandStart())
async def bot_start(message: types.Message, state: FSMContext):
    marathon_member = await MarathonMembersModel.get_marathon_member(message.from_user.id)
    if marathon_member is None:
        await state.finish()
        await FunnelUsersModel.add_funnel_user(
            telegram_id=message.from_user.id,
            username=message.from_user.username,
            last_message='/start',
            last_update_time=time.time()
        )
        await message.answer(
            f"–ü—Ä–∏–≤–µ—Ç, {message.from_user.first_name} üëã\n"
            f"–†–∞–∑ —Ç—ã –ø–µ—Ä–µ—à–µ–ª(–∞) –ø–æ —ç—Ç–æ–π —Å—Å—ã–ª–∫–µ - –∑–Ω–∞—á–∏—Ç —Ç–µ–±–µ –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã —Ä–∞–Ω–Ω–∏–µ –ø–æ–¥—ä—ë–º—ã."
            f"–ß—Ç–æ-—Ç–æ —Ç–µ–±—è –≤ –Ω–∏—Ö –ø—Ä–∏–≤–ª–µ–∫–∞–µ—Ç. –¢—ã —Ö–æ—á–µ—à—å –∏—Å–ø—ã—Ç–∞—Ç—å —ç—Ç–æ —á—É–≤—Å—Ç–≤–æ, –∫–æ–≥–¥–∞ —Ç—ã –≤—Å—Ç–∞–ª, –∞ –≤–µ—Å—å –º–∏—Ä –µ—â—ë —Å–ø–∏—Ç. "
            f"–ò–ª–∏ —Ç—ã –ø—Ä–æ—Å—Ç–æ –ª—é–±–æ–ø—ã—Ç–Ω–∏—á–∞–µ—à—å, –ø—Ä–∏–æ—Ç–∫—Ä—ã–≤–∞–µ—à—å –¥–≤–µ—Ä–∫—É, —á—Ç–æ–±—ã –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å: ‚Äú–ê —Å–º–æ–≥—É –ª–∏ —è? –ü–æ–ª—É—á–∏—Ç—Å—è? "
            f"–ù–∞–¥–æ –ª–∏ –º–Ω–µ?‚Äù –û–¥–Ω–æ –∑–Ω–∞—é —Ç–æ—á–Ω–æ: –Ω–∏—á–µ–≥–æ –Ω–µ –±—ã–≤–∞–µ—Ç –ø—Ä–æ—Å—Ç–æ —Ç–∞–∫. –ò –µ—Å–ª–∏ —Ç—ã –∑–¥–µ—Å—å, —Ç–æ –≤ —Ç–≤–æ—ë–º –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–µ "
            f"–≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ —Ç–æ—á–Ω–æ –µ—Å—Ç—å –¢–´"
            f"–∫–æ—Ç–æ—Ä—ã–π(–∞—è) –≤—Å—Ç–∞–µ—Ç –≤ 5 —É—Ç—Ä–∞ –∏ –∫–∞–π—Ñ—É–µ—Ç –æ—Ç —ç—Ç–æ–≥–æ",
            reply_markup=create_markup(
                2, '–î–∞, –±—ã–ª–æ –¥–µ–ª–æ', '–ù–ï–¢, –Ω–æ —Ö–æ—á—É –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å', '–ü—Ä–æ–±–æ–≤–∞–ª(–∞), –Ω–æ –Ω–µ –ø–æ–ª—É—á–∞–µ—Ç—Å—è',
                '–Ø –Ω–µ —Å—É–º–∞—Å—à–µ–¥—à–∏–π',
            )
        )

        await FunnelUsers.try_wakeup.set()
    else:
        await message.answer("–¢—ã —É–∂–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª –¥–∞–Ω–Ω—É—é –∫–æ–º–∞–Ω–¥—É")


@dp.message_handler(state=FunnelUsers.try_wakeup)
async def try_wakeup(message: types.Message, state: FSMContext):
    await update_funnel_user(message)
    text = message.text
    if text == "–î–∞, –±—ã–ª–æ –¥–µ–ª–æ":
        await message.answer('–¢—ã –º–æ–ª–æ–¥–µ—Ü! –ó–Ω–∞—á–∏—Ç —Ç–æ—á–Ω–æ —Å–º–æ–∂–µ—à—å –≤–Ω–µ–¥—Ä–∏—Ç—å —Ä–∞–Ω–Ω–∏–µ –ø–æ–¥—ä—ë–º—ã –≤ —Å–≤–æ—é –∂–∏–∑–Ω—å –Ω–∞ –ø–æ—Å—Ç–æ—è–Ω–Ω–æ–π '
                             '–æ—Å–Ω–æ–≤–µ. –ö–∞–∫ –≥–ª–∞—Å–∏—Ç –∏–∑–≤–µ—Å—Ç–Ω–∞—è —Ñ—Ä–∞–∑–∞: ‚Äú–ù–µ –±–æ–π—Å—è, —á—Ç–æ –Ω–µ –ø–æ–ª—É—á–∞–µ—Ç—Å—è —Å –ø–µ—Ä–≤–æ–≥–æ —Ä–∞–∑–∞. '
                             '–ë–æ–π—Å—è, —á—Ç–æ –Ω–µ –ø—Ä–æ–±—É–µ—à—å‚Äù')
        await has_idea(message, state)
    elif text == "–ù–ï–¢, –Ω–æ —Ö–æ—á—É –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å":
        await message.answer('–£—Ä–∞! –ó–Ω–∞—á–∏—Ç –≤ —Ç–µ–±–µ –µ—Å—Ç—å –æ–≥—Ä–æ–º–Ω—ã–π –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª –≤–Ω–µ–¥—Ä–∏—Ç—å —ç—Ç—É —É–Ω–∏–∫–∞–ª—å–Ω—É—é –ø—Ä–∏–≤—ã—á–∫—É –≤ —Å–≤–æ—é –∂–∏–∑–Ω—å.')
        await has_idea(message, state)
    elif text == "–ü—Ä–æ–±–æ–≤–∞–ª(–∞), –Ω–æ –Ω–µ –ø–æ–ª—É—á–∞–µ—Ç—Å—è":
        await message.answer('–¢—ã –º–æ–ª–æ–¥–µ—Ü! –ó–Ω–∞—á–∏—Ç —Ç–æ—á–Ω–æ —Å–º–æ–∂–µ—à—å –≤–Ω–µ–¥—Ä–∏—Ç—å —Ä–∞–Ω–Ω–∏–µ –ø–æ–¥—ä—ë–º—ã –≤ —Å–≤–æ—é –∂–∏–∑–Ω—å –Ω–∞ –ø–æ—Å—Ç–æ—è–Ω–Ω–æ–π '
                             '–æ—Å–Ω–æ–≤–µ. –ö–∞–∫ –≥–ª–∞—Å–∏—Ç –∏–∑–≤–µ—Å—Ç–Ω–∞—è —Ñ—Ä–∞–∑–∞: ‚Äú–ù–µ –±–æ–π—Å—è, —á—Ç–æ –Ω–µ –ø–æ–ª—É—á–∞–µ—Ç—Å—è —Å –ø–µ—Ä–≤–æ–≥–æ —Ä–∞–∑–∞. '
                             '–ë–æ–π—Å—è, —á—Ç–æ –Ω–µ –ø—Ä–æ–±—É–µ—à—å‚Äù')
        await has_idea(message, state)
    elif text == "–Ø –Ω–µ —Å—É–º–∞—Å—à–µ–¥—à–∏–π":
        await message.answer('–î–∞, —Ç—ã –ø—Ä–∞–≤(–∞) üòÅ –ü—Ä–æ —Å—É–º–∞—Å—à–µ–¥—à–∏—Ö')
        await message.answer('–ö–∞–∫ –≥–æ–≤–æ—Ä–∏–ª–∞ –ê–ª–∏—Å–∞, —Ç–∞ —Å–∞–º–∞—è –∏–∑ —Å—Ç—Ä–∞–Ω—ã —á—É–¥–µ—Å: '
                             '‚Äú–¢–∞–∫ –∏ –µ—Å—Ç—å ‚Äî —Å —É–º–∞ —Å–æ—à–ª–∞, —Å–ø—è—Ç–∏–ª–∞, —á–æ–∫–Ω—É–ª–∞—Å—å!.. –û—Ç–∫—Ä–æ—é —Ç–µ–±–µ —Å–µ–∫—Ä–µ—Ç: –±–µ–∑—É–º—Ü—ã –≤—Å–µ—Ö '
                             '—É–º–Ω–µ–π.‚Äù')
        await message.answer('–ê –í–∏–ª—å—è–º –®–µ–∫—Å–ø–∏—Ä —Å—á–∏—Ç–∞–ª, —á—Ç–æ ‚Äú–£ –≤—Å—è–∫–æ–≥–æ –±–µ–∑—É–º–∏—è –µ—Å—Ç—å —Å–≤–æ—è –ª–æ–≥–∏–∫–∞‚Äù. –ö–∞–∫ –¥—É–º–∞–µ—à—å, '
                             '–æ–Ω–∏ –ø—Ä–∞–≤—ã?',
                             reply_markup=create_markup(2, '–í —ç—Ç–æ–º —á—Ç–æ-—Ç–æ –µ—Å—Ç—å', '–ë–µ–∑—É–º—Ü—ã)')
                             )
        await FunnelUsers.are_they_right.set()
        return
    else:
        await message.answer('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏ –æ–¥–∏–Ω –∏–∑ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –æ—Ç–≤–µ—Ç–∞')
        return

    await FunnelUsers.has_idea.set()


@dp.message_handler(state=FunnelUsers.are_they_right)
async def are_they_right(message: types.Message, state: FSMContext):
    if message.text == '–í —ç—Ç–æ–º —á—Ç–æ-—Ç–æ –µ—Å—Ç—å' or message.text == '–ë–µ–∑—É–º—Ü—ã)':
        await update_funnel_user(message)
        await has_idea(message, state)
        await FunnelUsers.has_idea.set()
    else:
        await message.answer("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏ –æ–¥–∏–Ω –∏–∑ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –æ—Ç–≤–µ—Ç–∞")


async def is_interested(message: types.Message, state: FSMContext):
    await message.answer(
        "–†–∞–Ω–Ω–∏–µ –ø–æ–¥—ä—ë–º—ã - —ç—Ç–æ –ø—Ä–∏–≤—ã—á–∫–∞, –∫–æ—Ç–æ—Ä—É—é –≤–Ω–µ–¥—Ä–∏—Ç—å –≤ –æ–¥–∏–Ω–æ—á–∫—É –Ω–µ–≤–µ—Ä–æ—è—Ç–Ω–æ —Å–ª–æ–∂–Ω–∞—è –∑–∞–¥–∞—á–∞. "
        "–ö—Ç–æ –ø—Ä–æ–±–æ–≤–∞–ª - —Ç–æ—Ç –∑–Ω–∞–µ—Ç."
    )
    await message.answer("–ë—Ä–æ—Å–∞—é —Ç–µ–±–µ –≤—ã–∑–æ–≤ –∏ –ø—Ä–∏–≥–ª–∞—à–∞—é –≤ –æ–Ω–ª–∞–π–Ω-—á–µ–ª–ª–µ–Ω–¥–∂ –ø–æ –≤–Ω–µ–¥—Ä–µ–Ω–∏—é —Ä–∞–Ω–Ω–∏—Ö –ø–æ–¥—ä–µ–º–æ–≤ üïî‚ú®")
    await message.answer(
        "–° —á–µ–ª–ª–µ–Ω–¥–∂–µ–º —É —Ç–µ–±—è:\n\n"
        "üî• –û–¥–Ω–æ–∑–Ω–∞—á–Ω–æ –±—É–¥–µ—Ç –±–æ–ª—å—à–µ —ç–Ω–µ—Ä–≥–∏–∏\n"
        "üß† –ü–æ–º–µ–Ω—è—é—Ç—Å—è –Ω–µ–π—Ä–æ–Ω–Ω—ã–µ —Å–≤—è–∑–∏ –∏ –¥–æ—Ä–æ–≥–∏\n"
        "üöÄ –£–≤–µ–ª–∏—á–∞—Ç—Å—è —Å–∫–æ—Ä–æ—Å—Ç–∏ –∏ –±—É–¥–µ—à—å –±–æ–ª—å—à–µ —É—Å–ø–µ–≤–∞—Ç—å\n"
        "üòç –ü–æ–¥—Ç—è–Ω–µ—Ç—Å—è —Ñ–∏–≥—É—Ä–∞\n"
        "üïî –ü–æ—è–≤–∏—Ç—Å—è —Ä–µ–∂–∏–º\n"
        "‚öîÔ∏è –ò–∑–±–∞–≤–∏—à—å—Å—è –æ—Ç –ø—Ä–æ–∫—Ä–∞—Å—Ç–∏–Ω–∞—Ü–∏–∏\n"
        "üìö –ù–∞—á–Ω—ë—à—å —á–∏—Ç–∞—Ç—å –∫–Ω–∏–≥–∏\n"
        "üë• –ü–æ–ª—É—á–∏—à—å –º–æ—â–Ω—É—é –ø–æ–¥–¥–µ—Ä–∂–∫—É –µ–¥–∏–Ω–æ–º—ã—à–ª–µ–Ω–Ω–∏–∫–æ–≤\n"
        "‚ú®–ù–∞–π–¥–µ—à—å –≤—Ä–µ–º—è –¥–ª—è –º–µ–¥–∏—Ç–∞—Ü–∏–π, —Ç–∏—à–∏–Ω—ã –∏ –∏–Ω—Å–∞–π—Ç–æ–≤\n"
        "üí™ –ü—Ä–æ–∫–∞—á–∞–µ—à—å —Å–∏–ª—É –≤–æ–ª–∏\n"
        "üí™ –ü–æ–±–µ–¥–∏—à—å –ª–µ–Ω—å –∏ –≤–µ—á–Ω—ã–µ –æ—Ç–º–∞–∑–∫–∞–º–∏.\n\n"
        "–ù—É –∫–∞–∫ —Ç–µ–±–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ?\n\n"
        "–†–∞—Å—Å–∫–∞–∑–∞—Ç—å —Ç–µ–±–µ –ø–æ–±–æ–ª—å—à–µ –æ –Ω–∞—Å?",
        reply_markup=create_markup(2, '–î–ê, —Ä–∞—Å—Å–∫–∞–∂–∏', '–•–æ—á—É —É–∑–Ω–∞—Ç—å –∫–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç')
    )
    await FunnelUsers.about_author.set()


@dp.message_handler(state=FunnelUsers.has_idea)
async def has_idea_get_answer(message: types.Message, state: FSMContext):
    await update_funnel_user(message)
    text = message.text
    if text == '–î–ê':
        await message.answer("–£—Ä–∞! –ü–æ–∑–¥—Ä–∞–≤–ª—è—é —Å –æ—Ç–ª–∏—á–Ω—ã–º —Ä–µ—à–µ–Ω–∏–µ–º, –∫–æ—Ç–æ—Ä–æ–µ –∏–∑–º–µ–Ω–∏—Ç —Ç–≤–æ—é –∂–∏–∑–Ω—å –∫ –ª—É—á—à–µ–º—É.")
        await is_interested(message, state)
    elif text == "–ù–ï–¢":
        await message.answer("–¢—ã –Ω–∞–≤–µ—Ä–Ω–æ –¥—É–º–∞–µ—à—å —ç—Ç–æ –Ω–µ–ø–æ—Å–∏–ª—å–Ω–∞—è –∑–∞–¥–∞—á–∞. –ü–æ–∑–≤–æ–ª—å, –µ—â—ë –Ω–µ–º–Ω–æ–≥–æ –ø–æ—Ä–∞—Å—Å—É–∂–¥–∞–µ–º. "
                             "–í–æ–∑–º–æ–∂–Ω–æ —Ç—ã –ø–µ—Ä–µ–¥—É–º–∞–µ—à—å.",
                             reply_markup=create_markup(2, '–°–æ–≥–ª–∞—Å–µ–Ω', '–î–∞–≤–∞–π –ø–æ–ø—Ä–æ–±—É–µ–º')
                             )
        await FunnelUsers.lets_try.set()
    else:
        await message.answer("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏ –æ–¥–∏–Ω –∏–∑ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –æ—Ç–≤–µ—Ç–∞")


@dp.message_handler(state=FunnelUsers.lets_try)
async def lets_try(message: types.Message, state: FSMContext):
    if message.text == '–°–æ–≥–ª–∞—Å–µ–Ω' or message.text == '–î–∞–≤–∞–π –ø–æ–ø—Ä–æ–±—É–µ–º':
        await update_funnel_user(message)
        await is_interested(message, state)
    else:
        await message.answer("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏ –æ–¥–∏–Ω –∏–∑ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –æ—Ç–≤–µ—Ç–∞")


async def instruction(message: types.Message, state: FSMContext, author=False):
    markup = create_markup(2, '–ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å 3 –¥–Ω—è —á–µ–ª–ª–µ–Ω–¥–∂–∞', '–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –æ—Ç–∑—ã–≤—ã')
    if author:
        markup = create_markup(2, '–ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å 3 –¥–Ω—è —á–µ–ª–ª–µ–Ω–¥–∂–∞', '–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –æ—Ç–∑—ã–≤—ã', '–£–∑–Ω–∞—Ç—å –æ —Å–æ–∑–¥–∞—Ç–µ–ª–µ —á–µ–ª–ª–µ–Ω–¥–∞–∂–∞')
    await message.answer(
        "–ö–ê–ö –í–ù–ï–î–†–Ø–ï–¢–°–Ø –ü–†–ò–í–´–ß–ö–ê\n"
        "–ò—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è –≥–ª–∞—Å—è—Ç, —á—Ç–æ –Ω–∞ –≤–Ω–µ–¥—Ä–µ–Ω–∏–µ –ø—Ä–∏–≤—ã—á–∫–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –æ—Ç 5 –¥–æ 254 –¥–Ω–µ–π. –î–∞ üò≥ –ü—Ä–µ–¥—Å—Ç–∞–≤–ª—è–µ—Ç–µ –∫–∞–∫–æ–π —Ä–∞–∑–±–µ–≥!\n"
        "–î–æ–ª–≥–æ–µ –≤—Ä–µ–º—è –ø–æ–ø—É–ª—è—Ä–Ω–∞ –±—ã–ª–∞ –∫–æ–Ω—Ü–µ–ø—Ü–∏—è 21 –¥–Ω—è. –ò–º–µ–Ω–Ω–æ —Ç–∞–∫–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π —Å—á–∏—Ç–∞–ª–æ—Å—å –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–º –¥–ª—è "
        "–≤–Ω–µ–¥—Ä–µ–Ω–∏—è "
        "–Ω–æ–≤–æ–≥–æ –ø–æ—Å—Ç–æ—è–Ω–Ω–æ–≥–æ –¥–µ–π—Å—Ç–≤–∏—è –≤ –∂–∏–∑–Ω—å.\n"
        "–Ø –∂–µ –ø–æ—Å–ª–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è —Å—á–∏—Ç–∞—é, —á—Ç–æ –±–æ–ª—å—à–∏–Ω—Å—Ç–≤—É –ª—é–¥–µ–π –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ 21 –¥–Ω—è. –ú–æ–π –æ–ø—ã—Ç –≤–µ–¥–µ–Ω–∏—è –∫–ª—É–±–∞ —Ä–∞–Ω–Ω–∏—Ö "
        "–ø–æ–¥—ä—ë–º–æ–≤ –ø–æ–∑–≤–æ–ª—è–µ—Ç —Å–¥–µ–ª–∞—Ç—å —Ç–∞–∫–∏–µ –≤—ã–≤–æ–¥—ã\n."
        "‚úîÔ∏è –ü–µ—Ä–≤—ã–π —Ü–∏–∫–ª –∏–∑ 21 –¥–Ω—è —Ä–∞–∑—Ä—É—à–∞–µ—Ç—Å—è —Å—Ç–∞—Ä–∞—è –ø—Ä–∏–≤—ã—á–∫–∞ –ø–æ–∑–¥–Ω–∏—Ö —É–∫–ª–∞–¥—ã–≤–∞–Ω–∏–π –∏ –ø—Ä–∏–≤—ã–∫–∞–Ω–∏–µ –ø—Å–∏—Ö–∏–∫–∏ –∫ –Ω–æ–≤–æ–º—É "
        "—Ä–µ–∂–∏–º—É\n "
        "‚úîÔ∏è –í—Ç–æ—Ä–æ–π —Ü–∏–∫–ª –∏–∑ 21 –¥–Ω—è —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç—Å—è –ø—Ä–∏–≤—ã—á–∫–∞.\n"
        "‚úîÔ∏è –ò –≤ —Ç—Ä–µ—Ç–∏–π —Ü–∏–∫–ª 21 –¥–Ω—è –ø—Ä–∏–≤—ã—á–∫–∞ –∑–∞–∫—Ä–µ–ø–ª—è–µ—Ç—Å—è –∏ –∏ –∏–Ω—Ç–µ–≥—Ä–∏—Ä—É–µ—Ç—Å—è –≤ –∂–∏–∑–Ω—å.\n"
        "–ò—Ç–æ–≥–æ 63 –¥–Ω—è!\n –ê –≤ –∏–¥–µ–∞–ª–µ, –µ—Å–ª–∏ —Å–ª–µ–¥–æ–≤–∞—Ç—å —Å–∞–∫—Ä–∞–ª—å–Ω–æ–º—É —á–∏—Å–ª—É 108 –∏ –≤—ã–¥–µ—Ä–∂–∞—Ç—å —á–µ–ª–ª–µ–Ω–¥–∂ 108 –¥–Ω–µ–π, —Ç–æ –≤—ã —É–∂–µ "
        "–Ω–∏–∫–æ–≥–¥–∞ –Ω–µ —Å–æ–π–¥–µ—Ç–µ —Å —É—Å—Ç–æ–π—á–∏–≤–æ–π –Ω–µ–π—Ä–æ–Ω–Ω–æ–π —Å–≤—è–∑–∏ üî•"
    )

    await message.answer(
        "–ö–ê–ö –í–°–Å –£–°–¢–†–û–ï–ù–û –í –ß–ï–õ–õ–ï–ù–î–ñ–ï\n"
        "–ö–∞–∂–¥–æ–µ (!) —É—Ç—Ä–æ –≤ 5:00 –≤ –æ–±—â–∏–π —á–∞—Ç —É—á–∞—Å—Ç–Ω–∏–∫–∏ –æ—Ç—á–∏—Ç—ã–≤–∞—é—Ç—Å—è –æ –ø—Ä–æ–±—É–∂–¥–µ–Ω–∏–∏.\n"
        "–í—Ä–µ–º—è –º–æ–∂–µ—Ç –≤–∞—Ä—å–∏—Ä–æ–≤–∞—Ç—å—Å—è –æ—Ç 4:00 –¥–æ 5:10.\n\n"
        "–Ø —Ä–µ–∫–æ–º–µ–Ω–¥—É—é –Ω–∞—á–∏–Ω–∞—Ç—å —Å–≤–æ–π –ø–µ—Ä–≤—ã–π —á–∞—Å –¥–Ω—è —Å–æ —Å–ª–µ–¥—É—é—â–∏—Ö –¥–µ–π—Å—Ç–≤–∏–π:\n\n"
        "üèÉüèÉ‚Äç‚ôÄÔ∏è10-20 –º–∏–Ω - —Å–ø–æ—Ä—Ç / —Ñ–∏–∑–∏—á–µ—Å–∫–∏–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è –∏–ª–∏ –ø—Ä–æ–≥—É–ª–∫–∞ –Ω–∞ —É–ª–∏—Ü–µ\n"
        "üßò‚Äç‚ôÄÔ∏èüíÜ‚Äç‚ôÄÔ∏è 10-20 –º–∏–Ω - –º–µ–¥–∏—Ç–∞—Ü–∏—è/–∞—Ñ—Ñ–∏—Ä–º–∞—Ü–∏–∏ –∏–ª–∏ –¥—Ä—É–≥–∏–µ –º–µ–Ω—Ç–∞–ª—å–Ω—ã–µ/–¥—É—Ö–æ–≤–Ω—ã–µ –ø—Ä–∞–∫—Ç–∏–∫–∏\n"
        "üìö 20 –º–∏–Ω - —á—Ç–µ–Ω–∏–µ/—Å–∞–º–æ—Ä–∞–∑–≤–∏—Ç–∏–µ.\n"
        "–£–º–Ω—ã–π –±–æ—Ç —É—á–∏—Ç—ã–≤–∞–µ—Ç –≤–∞—à–∏ –ø–æ–¥—ä—ë–º—ã –∏ –Ω–µ –¥–∞—ë—Ç —Ä–∞—Å—Å–ª–∞–±–∏—Ç—å—Å—è –∏ –ø—Ä–æ—Å–ø–∞—Ç—å. –í–µ–¥—å –µ—Å–ª–∏ –ø—Ä–æ—Å–ø–∏—à—å –∏ –Ω–µ –æ—Ç—á–∏—Ç–∞–µ—à—å—Å—è - —Ç–æ "
        "—ç—Ç–æ –º–∏–Ω—É—Å ‚Äú–æ–¥–Ω–∞ –∂–∏–∑–Ω—å‚Äù. –ê –∂–∏–∑–Ω–µ–π –≤ —á–µ–ª–ª–µ–Ω–¥–∂–µ –≤—Å–µ–≥–æ 3! üò≥üòÅ\n"
        "–ó–¥–æ—Ä–æ–≤–æ –≤–µ–¥—å –≤ —Ñ–æ—Ä–º–∞—Ç–µ –∏–≥—Ä—ã –≤–Ω–µ–¥—Ä—è—Ç—å –ø—Ä–∏–≤—ã—á–∫—É –≤ —Å–≤–æ—é –∂–∏–∑–Ω—å!"
    )

    await message.answer(
        "–ê –µ—â—ë —É —Ç–µ–±—è –±—É–¥–µ—Ç –º–æ—â–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞ –º–µ–Ω—Ç–æ—Ä–∞, –µ–¥–∏–Ω–æ–º—ã—à–ª–µ–Ω–Ω–∏–∫–æ–≤ –∏ –¥–æ—Å—Ç—É–ø –∫ –æ–≥—Ä–æ–º–Ω–æ–π –±–∞–∑–µ –∑–Ω–∞–Ω–∏–π, "
        "–≥–¥–µ —Ç—ã —Å–º–æ–∂–µ—à—å –∏–∑—É—á–∏—Ç—å –ª–µ–∫—Ü–∏–∏ –ø—Ä–æ:\n"
        "üìå –ë–∏–æ—Ä–∏—Ç–º—ã\n"
        "üìå –°–µ–∫—Ä–µ—Ç—ã —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ–≥–æ —Å–Ω–∞\n"
        "üìå –§–∏—à–∫–∏ –∫–∞–∫ —Ä–∞—Å—Å—á–∏—Ç–∞—Ç—å —Å–≤–æ–π —Ü–∏–∫–ª —Å–Ω–∞\n"
        "üìå –°–≤—è–∑—å –ø–∏—Ç–∞–Ω–∏—è –∏ —Å–Ω–∞\n"
        "üìå –°–µ–∫—Ä–µ—Ç—ã —Ñ–µ–Ω-—à—É—è —Å–ø–∞–ª—å–Ω–∏\n"
        "üìå –ê—Ñ—Ñ–∏—Ä–º–∞—Ü–∏–∏\n"
        "üìå –í–≤–µ–¥–µ–Ω–∏–µ –≤ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—é\n"
        "üìå –ö–∞–∫ –Ω–∞—É—á–∏—Ç—å—Å—è —Å–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ –º–µ–¥–∏—Ç–∏—Ä–æ–≤–∞—Ç—å\n"
        "–ê –µ—â—ë –ø–æ–ª—É—á–∏—à—å –¥–æ—Å—Ç—É–ø:\n"
        "üìå –ë–æ–ª–µ–µ 10 —ç–Ω–µ—Ä–≥–µ—Ç–∏—á–µ—Å–∫–∏–º –∏ –º–µ–Ω—Ç–∞–ª—å–Ω—ã–º –ø—Ä–∞–∫—Ç–∏–∫–∞–º\n"
        "üìå –ü–æ–¥–±–æ—Ä–∫–∞ –º–µ–¥–∏—Ç–∞—Ü–∏–π\n"
        "üìå –≠–ª–µ–∫—Ç—Ä–æ–Ω–Ω—ã–µ –∫–Ω–∏–≥–∏ –ø–æ —Ä–∞–Ω–Ω–∏–º –ø–æ–¥—ä—ë–º–∞–º\n\n"
        "–ù–∞ —Å–∞–º–æ–º –¥–µ–ª–µ —ç—Ç–æ –Ω–µ –≤—Å–µ –ø—Ä–∞–≤–∏–ª–∞. –ü–æ–¥—Ä–æ–±–Ω–µ–µ –æ–±–æ –≤—Å—ë–º —Ç—ã –º–æ–∂–µ—à—å —É–∑–Ω–∞—Ç—å –Ω–∞ –ø—Ä–æ–±–Ω—ã—Ö 3—Ö –¥–Ω—è—Ö —á–µ–ª–ª–µ–Ω–¥–∂–∞.\n"
        "–ù—É —á—Ç–æ? –¢—ã –≥–æ—Ç–æ–≤(–∞)?",
        reply_markup=markup
    )

    await state.finish()


async def author_description(message, state, challenge_markup=False):
    markup = create_markup(2, '–ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å 3 –¥–Ω—è —á–µ–ª–ª–µ–Ω–¥–∂–∞', '–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –æ—Ç–∑—ã–≤—ã')
    if challenge_markup:
        markup = create_markup(1, '–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –ß–µ–ª–ª–µ–Ω–¥–∂')
    await message.answer_photo("https://scontent-hel3-1.cdninstagram.com/v/t51.2885-15/e35/242610079_223786276467332_8893897483567551067_n.jpg?_nc_ht=scontent-hel3-1.cdninstagram.com&_nc_cat=108&_nc_ohc=ZqfmVba4MwgAX8krTGT&edm=AABBvjUBAAAA&ccb=7-4&oh=9cb83421c74be6ceb854e4843063f675&oe=6158807C&_nc_sid=83d603")
    await message.answer(
        "–ú–µ–Ω—è –∑–æ–≤—É—Ç –õ—é–±–æ–≤—å –°–∫–∞–±–µ–ª–∏–Ω–∞. –Ø –≤—Å—Ç–∞—é –≤ 5 —É—Ç—Ä–∞ —É–∂–µ –±–æ–ª–µ–µ 10 –ª–µ—Ç. "
        "–ù–∞—á–∞–ª–∞ –ø—Ä–∞–∫—Ç–∏–∫–æ–≤–∞—Ç—å —Ä–∞–Ω–Ω–∏–µ –ø–æ–¥—ä—ë–º—ã –µ—â—ë –∫–æ–≥–¥–∞ –•—ç–ª –≠–ª—Ä–æ–¥ –ø—Ä–æ –Ω–∏—Ö –Ω–µ –∑–∞–¥—É–º—ã–≤–∞–ª—Å—è. –î–∞, —ç—Ç–æ –∞–≤—Ç–æ—Ä "
        "–±–µ—Å—Ç—Å–µ–ª–ª–µ—Ä–∞ ‚Äú–ú–∞–≥–∏—è —É—Ç—Ä–∞‚Äù. –ò –†–æ–±–∏–Ω –®–∞—Ä–º–∞ —Ç–æ–∂–µ –µ—â—ë –Ω–µ –Ω–∞–ø–∏—Å–∞–ª —Å–≤–æ—é –∑–Ω–∞–º–µ–Ω–∏—Ç—É—é –∫–Ω–∏–≥—É ‚Äú–ö–ª—É–± 5 —É—Ç—Ä–∞‚Äù. –¢–∞–∫ —á—Ç–æ "
        "–ø–µ—Ä–µ–¥ –≤–∞–º–∏ —É–Ω–∏–∫–∞–ª—å–Ω—ã–π üòÅ  —ç–∫–∑–µ–º–ø–ª—è—Ä —á–µ–ª–æ–≤–µ–∫–∞, –∫–æ—Ç–æ—Ä—ã–π –ø–æ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ–π –≤–æ–ª–µ –∏ –∂–µ–ª–∞–Ω–∏—é —Ä–µ—à–∏–ª –≤—Å—Ç–∞–≤–∞—Ç—å –≤ 5 "
        "—É—Ç—Ä–∞. –î–∞ –µ—â—ë –ø–æ–ª—é–±–∏–ª —ç—Ç–æ –¥–µ–ª–æ –∏ –≤–Ω–µ–¥—Ä–∏–ª –≤ —Å–≤–æ—é –∂–∏–∑–Ω—å –Ω–∞ –ø–æ—Å—Ç–æ—è–Ω–Ω–æ–π –æ—Å–Ω–æ–≤–µ. "
        "–ö–∞–∫ —è –∫ —ç—Ç–æ–º—É –ø—Ä–∏—à–ª–∞ - —ç—Ç–æ –¥–ª–∏–Ω–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è. –ù–æ —Ç—ã –º–æ–∂–µ—à—å –µ—ë –ø—Ä–æ—á–∏—Ç–∞—Ç—å –≤ –º–æ—ë–º –±–ª–æ–≥–µ",
        reply_markup=inline_funnel_users_markups.instagram_link_markup()
    )
    await message.answer(
        "–í –¥–≤—É—Ö —Å–ª–æ–≤–∞—Ö –æ–±–æ –º–Ω–µ. –ú–Ω–µ 33 –≥–æ–¥–∞. –Ø –ø—Ä–∞–∫—Ç–∏–∫—É—é—â–∏–π –∫–æ—É—á –∏ –±–µ–∑ –ø—è—Ç–∏ –º–∏–Ω—É—Ç –ø—Å–∏—Ö–æ–ª–æ–≥. "
        "–ü–æ–ª—É—á–∞—é —Å–µ–π—á–∞—Å —Ç—Ä–µ—Ç—å–µ –≤—ã—Å—à–µ–µ –æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ. –ö–æ–≥–¥–∞-—Ç–æ —è –º–µ—á—Ç–∞–ª–∞ —Å—Ç–∞—Ç—å –ø–µ—Ä–µ–≤–æ–¥—á–∏–∫–æ–º –∏ –ø–µ—Ä–≤—ã–µ 2 –º–æ–∏ "
        "–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è - —ç—Ç–æ —É—á–∏—Ç–µ–ª—å –∏—Å—Ç–æ—Ä–∏–∏ –∏ –∞–Ω–≥–ª–∏–π—Å–∫–æ–≥–æ —è–∑—ã–∫–∞, –∞ —Ç–∞–∫–∂–µ –∞–Ω–≥–ª–æ-—Ä—É—Å—Å–∫–∏–π –ø–µ—Ä–µ–≤–æ–¥—á–∏–∫. –ù–æ –∂–∏–∑–Ω—å —Ç–∞–∫ "
        "—Å–ª–æ–∂–∏–ª–∞—Å—å, —á—Ç–æ —Å 20 –ª–µ—Ç —è –ø—Ä–µ–¥–ø—Ä–∏–Ω–∏–º–∞—Ç–µ–ª—å. –í —Ç–µ—á–µ–Ω–∏–µ 9 –ª–µ—Ç —É –º–µ–Ω—è –±—ã–ª —É—Å–ø–µ—à–Ω—ã–π –º–∏–Ω–∏-–º–∞—Ä–∫–µ—Ç —Ö–æ–∑—Ç–æ–≤–∞—Ä–æ–≤, "
        "–∫–æ—Ç–æ—Ä—ã–π —è –ø—Ä–æ–¥–∞–ª–∞ –ø–æ–ª–≥–æ–¥–∞ –Ω–∞–∑–∞–¥. –ò–±–æ –≥–æ—Ç–æ–≤–ª—é—Å—å –∫ –ø–µ—Ä–µ–µ–∑–¥—É –≤ —Ç—ë–ø–ª—ã–π —Ä–µ–≥–∏–æ–Ω. –ê –µ—â—ë –±—ã–ª–æ —à–≤–µ–π–Ω–æ–µ "
        "–ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ –∏ –æ–Ω–ª–∞–π–Ω-–º–∞–≥–∞–∑–∏–Ω. –¢–∞–∫ —á—Ç–æ –ø–µ—Ä–µ–¥ –≤–∞–º–∏ –Ω–µ –ø—Ä–æ—Å—Ç–æ –±–ª—É–∂–¥–∞—é—â–∏–π –±–ª–æ–≥–µ—Ä üòÑ –ê –µ—â—ë —è –º–∞—Ç—å 4 –¥–µ—Ç–µ–π üò≥ "
        "–î–∞, —Å–∞–º–∞ –≤ —à–æ–∫–µ ))\n"
        "–ü—Ä–∏—Å–∞–∂–∏–≤–∞–π—Å—è, –ø—Ä–æ—Ö–æ–¥–∏. –î–∞–≤–∞–π –¥—Ä—É–∂–∏—Ç—å ‚ù§Ô∏è",
        reply_markup=markup
    )
    await FunnelUsers.instruction.set()


@dp.message_handler(state=FunnelUsers.about_author)
async def about_author(message: types.Message, state: FSMContext):
    await update_funnel_user(message)
    text = message.text
    if text == "–î–ê, —Ä–∞—Å—Å–∫–∞–∂–∏":
        await author_description(message, state, True)
    elif text == "–•–æ—á—É —É–∑–Ω–∞—Ç—å –∫–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç":
        await instruction(message, state, author=True)
        await state.finish()
    else:
        await message.answer("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏ –æ–¥–∏–Ω –∏–∑ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –æ—Ç–≤–µ—Ç–∞")


@dp.message_handler(state=FunnelUsers.instruction)
async def send_instruction(message: types.Message, state: FSMContext):
    if message.text == '–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –ß–µ–ª–ª–µ–Ω–¥–∂':
        await update_funnel_user(message)
        await instruction(message, state)
        await state.finish()
    else:
        await message.answer("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏ –æ–¥–∏–Ω –∏–∑ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –æ—Ç–≤–µ—Ç–∞")


@dp.message_handler(text="–£–∑–Ω–∞—Ç—å –æ —Å–æ–∑–¥–∞—Ç–µ–ª–µ —á–µ–ª–ª–µ–Ω–¥–∞–∂–∞")
async def about_author_message(message: types.Message, state: FSMContext):
    await update_funnel_user(message)
    await author_description(message, state,)
    await state.finish()


@dp.message_handler(text="–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –æ—Ç–∑—ã–≤—ã")
async def about_author_message(message: types.Message, state: FSMContext):
    await update_funnel_user(message)
    reviews = await ReviewsModel.get_reviews()

    album = types.MediaGroup()
    for review in reviews:
        if review.photo_id:
            album.attach_photo(review.photo_id)
        elif review.video_id:
            album.attach_video(review.video_id)

    await message.answer_media_group(
        media=album,
    )

    markup = Paginator('paginator', 'reviews').create_markup(
        max_items=len(reviews),
    )
    review = reviews[0]
    if review.photo_id:
        await message.answer_photo(
            photo=review.photo_id,
            reply_markup=markup
        )
    elif review.video_id:
        await message.answer_video(
            video=review.video_id,
            reply_markup=markup
        )

    await state.finish()


@dp.callback_query_handler(pagination_callback.filter(key='reviews', page='curr_page'))
async def curr_page(callback: types.CallbackQuery):
    await callback.answer(cache_time=60)


@dp.callback_query_handler(pagination_callback.filter(key='reviews'))
async def show_chosen_article(callback: types.CallbackQuery, callback_data: dict):
    await callback.answer()
    current_page = int(callback_data.get('page'))
    reviews = await ReviewsModel.get_reviews()
    review = reviews[current_page-1]

    markup = Paginator('paginator', 'reviews').create_markup(
        max_items=len(reviews),
        curr_page=current_page,
    )

    if review.photo_id:
        await callback.message.answer_photo(
            photo=review.photo_id,
            reply_markup=markup,
        )
    elif review.video_id:
        await callback.message.answer_video(
            video=review.video_id,
            reply_markup=markup,
        )

    await callback.message.delete()



